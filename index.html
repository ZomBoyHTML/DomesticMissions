<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DomesticMissions</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            background: #000;
            color: #00ff00;
            font-family: "Courier New", monospace;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .app {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1,
        h2,
        label,
        p {
            color: #00ff00;
        }

        input,
        textarea,
        select {
            width: 100%;
            max-width: 250px;
            display: block;
            margin: 6px auto;
            padding: 8px 10px;
            border: 1px solid #00ff00;
            border-radius: 4px;
            background: black;
            color: #00ff00;
            font-family: "Courier New", monospace;
        }


        button {
            background: black;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 14px;
            margin: 4px;
            cursor: pointer;
            font-family: "Courier New", monospace;
        }

        button:hover {
            background: #003300;
        }

        .mission {
            border: 1px solid #00ff00;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            background: #000;
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .mission-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .mission-desc {
            font-size: 13px;
            margin-bottom: 5px;
        }

        .mission-time {
            font-size: 12px;
            margin-bottom: 5px;
        }

        .mission-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-footer .status {
            font-size: 13px;
            font-weight: bold;
        }

        .mission-footer .actions {
            display: flex;
            gap: 6px;
        }

        .mission-footer button {
            padding: 4px 8px;
            font-size: 12px;
        }

        .status {
            font-weight: bold;
            display: inline-block;
            margin-top: 6px;
        }

        .status.pending {
            color: #8eada0;
        }

        .status.active {
            color: #30ffba;
        }

        .status.failed {
            color: #777;
        }

        .status.done {
            color: #00aaff;
        }

        .count {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .small {
            font-size: 12px;
            color: #00ff00;
        }

        .footer {
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: gray;
            padding: 10px 0;
            margin-top: 10px;
        }

        #backBtn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: black;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        #backBtn:hover {
            background: #003300;
        }
    </style>
</head>

<body>
    <div class="app">
        <button id="backBtn" style="display:none">&lt;&lt;</button>
        <h1>Domestic Missions</h1>
        <div id="authArea">
            <label>Nombre de usuario</label>
            <input id="username" type="text" placeholder="ej: juanito" maxlength="32" />
            <label>PIN (4 dígitos)</label>
            <input id="pin" type="number" placeholder="1234" min="0" max="9999" />
            <div>
                <button id="loginBtn">Entrar / Crear</button>
                <button id="logoutBtn" style="display:none">Cerrar</button>
            </div>
            <p class="small">Los datos se guardan en tu navegador (localStorage).</p>
        </div>

        <div id="addMissionArea" style="display:none;margin-top:20px">
            <label>Título</label>
            <input id="mTitle" type="text" placeholder="Ordenar la pieza" />
            <label>Descripción</label>
            <textarea id="mDesc" rows="3" placeholder="Qué te pidieron..."></textarea>
            <div>
                <button id="addMissionBtn">Añadir misión</button>
                <button id="clearBtn">Limpiar</button>
            </div>
        </div>

        <h2 style="margin-top:20px">Misiones</h2>
        <div id="missionsList"></div>
    </div>
    <div class="footer">&copy; ZomBoyHTML</div>


    <script>
        function nowInChile() {
            const s = new Date().toLocaleString('en-US', { timeZone: 'America/Santiago' });
            return new Date(s);
        }
        function endOfChileDay() {
            const d = nowInChile();
            const e = new Date(d);
            e.setHours(23, 59, 59, 999);
            return e;
        }
        function msToHMS(ms) {
            if (ms <= 0) return '00:00:00';
            const sec = Math.floor(ms / 1000);
            const h = String(Math.floor(sec / 3600)).padStart(2, '0');
            const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
            const s = String(sec % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }


        let countdownInterval = null;



        function pinKey(pin) { return String(pin || '').padStart(4, '0').slice(-4); }
        function storageKeyFor(user, pin) { return `sg_user_${user}___${pinKey(pin)}`; }
        function loadMissions(u, p) { try { return JSON.parse(localStorage.getItem(storageKeyFor(u, p))) || [] } catch { return [] } }
        function saveMissions(u, p, m) { localStorage.setItem(storageKeyFor(u, p), JSON.stringify(m)); }

        let currentUser = null, currentPin = null, missions = [], selectedId = null, countdownTimer = null;

        const usernameEl = document.getElementById('username');
        const pinEl = document.getElementById('pin');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const addMissionArea = document.getElementById('addMissionArea');
        const addMissionBtn = document.getElementById('addMissionBtn');
        const clearBtn = document.getElementById('clearBtn');
        const mTitle = document.getElementById('mTitle');
        const mDesc = document.getElementById('mDesc');
        const missionsList = document.getElementById('missionsList');
        const startBtn = document.getElementById('startBtn');
        const completeBtn = document.getElementById('completeBtn');
        const countdownEl = document.getElementById('countdown');
        const backBtn = document.getElementById('backBtn');

        loginBtn.addEventListener('click', () => {
            const u = (usernameEl.value || '').trim();
            const p = String(pinEl.value || '').replace(/\D/g, '');
            if (!u || !p) { alert('Escribe usuario y PIN'); return; }
            currentUser = u; currentPin = pinKey(p);
            missions = loadMissions(currentUser, currentPin);
            document.getElementById('authArea').style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            addMissionArea.style.display = 'block';
            renderMissionsList();
            backBtn.style.display = 'inline-block';
        });

        backBtn.addEventListener('click', () => {
            document.getElementById('authArea').style.display = 'block';
            addMissionArea.style.display = 'none';
            missionsList.innerHTML = '';
            backBtn.style.display = 'none';
        });

        logoutBtn.addEventListener('click', () => { location.reload(); });

        addMissionBtn.addEventListener('click', () => {
            const t = (mTitle.value || '').trim();
            if (!t) { alert('Pon un título'); return; }
            const d = (mDesc.value || '').trim();
            const id = 'm_' + Date.now();
            missions.unshift({ id, title: t, desc: d, status: 'pending' });
            saveMissions(currentUser, currentPin, missions);
            renderMissionsList();
            mTitle.value = ''; mDesc.value = '';
        });

        clearBtn.addEventListener('click', () => { mTitle.value = ''; mDesc.value = ''; });

        function renderMissionsList() {
            missionsList.innerHTML = '';
            if (missions.length === 0) {
                missionsList.innerHTML = '<p class="small">No hay misiones.</p>';
                return;
            }

            missions.forEach(m => {
                const div = document.createElement('div');
                div.className = 'mission';

                // Cabecera
                const header = document.createElement('div');
                header.className = 'mission-header';
                header.textContent = m.title;

                // Descripción
                const desc = document.createElement('div');
                desc.className = 'mission-desc';
                desc.textContent = m.desc || '';

                // Tiempo restante
                const time = document.createElement('div');
                time.className = 'mission-time';
                time.setAttribute('data-id', m.id);
                div.appendChild(header);
                div.appendChild(desc);
                div.appendChild(time);

                // Footer con estado y botones
                const footer = document.createElement('div');
                footer.className = 'mission-footer';

                const st = document.createElement('div');
                st.className = 'status ' + m.status;
                st.textContent = 'Estado: ' + statusText(m.status);

                const actions = document.createElement('div');
                actions.className = 'actions';

                // Botones según estado
                if (m.status === 'pending') {
                    const startBtn = document.createElement('button');
                    startBtn.textContent = 'Iniciar';
                    startBtn.onclick = () => {
                        m.status = 'active';
                        m.startedAt = Date.now();
                        saveMissions(currentUser, currentPin, missions);
                        renderMissionsList();
                    };
                    actions.appendChild(startBtn);
                } else if (m.status === 'active') {
                    const doneBtn = document.createElement('button');
                    doneBtn.textContent = 'Completar';
                    doneBtn.onclick = () => {
                        m.status = 'done';
                        m.completedAt = Date.now();
                        saveMissions(currentUser, currentPin, missions);
                        renderMissionsList();
                    };
                    actions.appendChild(doneBtn);
                }

                // Borrar
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Borrar';
                delBtn.onclick = () => {
                    if (confirm("¿Seguro que quieres borrar esta misión?")) {
                        missions = missions.filter(x => x.id !== m.id);
                        saveMissions(currentUser, currentPin, missions);
                        renderMissionsList();
                    }
                };

                const rem = endOfChileDay() - nowInChile();
                if (rem <= 0 && m.status === "pending") {
                    m.status = "failed";
                    saveMissions(currentUser, currentPin, missions);
                }

                actions.appendChild(delBtn);

                footer.appendChild(st);
                footer.appendChild(actions);
                div.appendChild(footer);
                missionsList.appendChild(div);
            });
        }


        function statusText(s) { if (s === 'pending') return 'Pendiente'; if (s === 'active') return 'Activa'; if (s === 'failed') return 'Fallida'; if (s === 'done') return 'Completada'; return s; }

        setInterval(() => {
            document.querySelectorAll('.mission-time').forEach(el => {
                const id = el.getAttribute('data-id');
                const m = missions.find(x => x.id === id);
                if (!m) return;
                const remaining = endOfChileDay() - nowInChile();
                el.textContent = 'Tiempo: ' + msToHMS(remaining);
            });
        }, 1000);

    </script>
</body>


</html>
